---
title: "Add HCRIS data"
format: html
editor: visual
embed-resources: true
---

## Setup

Load necessary libraries:

```{r}
library(tidyverse)
library(tidyr)
library(dplyr)
library(janitor)
library(ggplot2)
library(hrbrthemes)
library(GGally)
library(tabulator)
library(readxl)
library(broom)
library(plm)
library(openxlsx)
```

Load in manually cleaned data set:

```{r}
Manual_matched <- read_excel("Data_manual_cleaning.xlsx", 
    sheet = "Deleted non matched", skip = 2)
View(Manual_matched)
```

Load in NASHP ownership data:

```{r}
NASHP <- read_excel("NASHP HCT Data 2024 July.xlsx", 
    sheet = "Downloadable")
View(NASHP)
```

Filter NASHP data to focus on New York.

```{r}

cleaned_NASHP <- NASHP %>% filter(State == "NY") 
```

R sometimes throws errors due to the complexity of the NASHP data set. In order to prevent future loading and crashing problems I write the filtered data set so I have a backup for potential use in future. Name new csv file cleanNASHP in the data folder under Thesis GU.

```{r}
write.csv(cleaned_NASHP, "C:/Users/Mitchell/Documents/Thesis GU/Data/cleanNASHP.csv")
print(cleaned_NASHP)
```

Exploring cleaned NASHP data.

```{r}
View(cleaned_NASHP %>% count(`Hospital Ownership Type`))

for_viz <-(cleaned_NASHP %>% group_by(Year) %>% count(`Hospital Ownership Type`))
```

Visualize hospital ownership count by year.

```{r}
for_viz %>% ggplot(mapping = aes(x = `Hospital Ownership Type`, fill = Year, y = n)) + geom_bar(position = "dodge", stat = "identity") 

```

Trying to do a percent bar chart. Not successful yet.

```{r}
for_viz %>% ggplot(mapping = aes(x = `Hospital Ownership Type`, fill = Year, y = n)) + geom_bar(position = "fill", stat = "identity") +   scale_color_gradient2(low = "blue", high = "orange") 
```

\*Grouped line chart.

```{r}
for_viz %>% ggplot(mapping = aes(x = Year, group = `Hospital Ownership Type`, y = n, color = `Hospital Ownership Type`)) +
  geom_line() + scale_y_continuous(breaks = seq(0, 175, by = 25)) + theme_minimal()
```

Merge manually cleaned set to cleaned NASHP data set by CCN.

```{r}
ccn_cleaned_NASHP <- cleaned_NASHP %>% rename( ccn = `CCN#`) %>% transform(ccn= as.numeric(ccn))

Combined <- full_join(x = Manual_matched,
          y = ccn_cleaned_NASHP,
          by = "ccn",
          copy = FALSE,
          keep = NULL) %>% clean_names()
```

Load SPARCS data set

```{r}

library(readr)
ppc_rates <- read_csv("All_Payer_Inpatient_Major_Potentially_Preventable_Complication__PPC__Rates_by_Hospital__SPARCS___Beginning_2013_20241001.csv")
View(ppc_rates)
```

Merging SPARCS data set to NASHP and Manual matched. Use right join to maintain the additional years of observations not present in ppc_rates data.

\[right_join

by argument c("facility","year")\]

```{r}
ppc_rates_janitor <- ppc_rates %>% clean_names() %>% rename( year = discharge_year)

SPARCS_combined <- right_join(x = ppc_rates_janitor,
                             y = Combined,
                             by = c("facility_id", "year"),
                             copy = FALSE,
                             keep = NULL)
```

Add in AHRQ cross sectional data sets. Note documentation shows that coding is not standardized between years. For instance a 2 in hospital ownership in 2022 is a public or governmental hospital while in 2020 a 2 means church-operated. Only 2021 includes 4 equals federal.

```{r}
AHRQ2022 <- read_excel("AHRQ datasets/chsp-hospital-linkage-2022-rev.xlsx")
View(AHRQ2022)

Cleaned2022 <- AHRQ2022 %>% filter(hospital_state == "NY")

graphed2022 <- Cleaned2022 %>% count(is.na(hos_ownership)) %>% mutate(logic = `is.na(hos_ownership)`)

ggplot(graphed2022, aes(x=logic, y=n)) + geom_bar(stat = "identity", position = "dodge")

Cleanedmore2022 <- Cleaned2022 %>% mutate(year = case_when(
  hospital_state == "NY" ~ 2022
)) %>% mutate(hos_ownership = case_when(
  hos_ownership == 1 ~ "Non-Profit",
  hos_ownership == 2 ~ "Governmental",
  hos_ownership == 3 ~ "Church-Operated",
  hos_ownership == 5 ~ "For-Profit"
  )) %>% transform(ccn = as.double(ccn))


#^recode var hos_ownership so the number are characters. 

AHRQ2021 <- read_excel("AHRQ datasets/chsp-hospital-linkage-2021-rev.xlsx")
View(AHRQ2021)

Cleaned2021 <- AHRQ2021 %>% filter(hospital_state == "NY") %>% mutate(year = case_when(
  hospital_state == "NY" ~ 2021
)) %>% mutate(hos_ownership = case_when(
  hos_ownership == 1 ~ "Non-Profit",
  hos_ownership == 2 ~ "Church-Operated",
  hos_ownership == 3 ~ "Governmental",
  hos_ownership == 4 ~ "Federal",
  hos_ownership == 5 ~ "For-Profit"
  )) %>% transform(ccn = as.double(ccn))

#^recode var hos_ownership so the number are characters. 

AHRQ2020 <- read_excel("AHRQ datasets/chsp-hospital-linkage-2020-rev.xlsx")
View(AHRQ2020)

Cleaned2020 <- AHRQ2020 %>% filter(hospital_state == "NY") %>% mutate(year = case_when(
  hospital_state == "NY" ~ 2020
)) %>% mutate(hos_ownership = case_when(
  hos_ownership == 1 ~ "Non-Profit",
  hos_ownership == 2 ~ "Church-Operated",
  hos_ownership == 3 ~ "Governmental",
  hos_ownership == 5 ~ "For-Profit"
  )) %>% transform(ccn = as.double(ccn))
```

Combine AHRQ cross-sectional data with already combined data sets (NASHP/SPARCS/Manually Cleaned).

```{r}
Fully_combined <- left_join(
  x = SPARCS_combined,
  y = Cleanedmore2022,
  by = c("ccn", "year"),
  copy = FALSE,
  keep = NULL) 

Fully_combined <- left_join(
  x = Fully_combined,
  y = Cleaned2021,
  by = c("ccn", "year"),
  copy = FALSE,
  keep = NULL)

Fully_combined <- left_join(
  x = Fully_combined,
  y = Cleaned2020,
  by = c("ccn", "year"),
  copy = FALSE,
  keep = NULL)
```

Write fully combined data set to excel as a backup and for my advisor.

```{r}
write.xlsx(Fully_combined, 'Fully_combined_dataset.xlsx')
```

## County Data

```{r}

```




## Add Cross Sectional County Data
```{r}

# 2011
year_2011 <- read_excel("County_data/2011 County Health Ranking New York Data - v4.xlsx", 
    sheet = "Additional Measure Data",
    skip = 1) %>%
  drop_na(County)

year_2011_v2 <- read_excel("County_data/2011 County Health Ranking New York Data - v4.xlsx", 
    sheet = "Ranked Measure Data", skip = 1) %>%
  drop_na(County)

combined_2011 <- full_join(year_2011,
                           year_2011_v2,
                           by = "County",
                           keep = FALSE)

combined_2011 <- combined_2011 %>%
  mutate(year = 2011) %>%
  clean_names() %>%
  select(county,
         year,
         rural,
         female,
         percent_children_in_poverty, percent_unemployed,
         percent_smokers,
         percent_obese,
         percent_excessive_drinking,
         percent_uninsured, 
         household_income,
         mentally_unhealthy_days,
         population_4,
         x65_and_over,
         african_american,
         hispanic,
         percent_not_proficient_in_english)

# 2012
year_2012 <- read_excel("County_data/2012 County Health Ranking New York Data - v4.xlsx", 
    sheet = "Ranked Measure Data", skip = 1) %>%
  drop_na(County)

year_2012_v2 <- read_excel("County_data/2012 County Health Ranking New York Data - v4.xlsx", 
    sheet = "Additional Measure Data", skip = 1) %>%
  drop_na(County)

combined_2012 <- full_join(year_2012,
                           year_2012_v2,
                           by = "County",
                           keep = FALSE)

combined_2012 <- combined_2012 %>%
  mutate(year = 2012) %>%
  clean_names() %>%
  select(county,
         year,
         rural,
         female,
         percent_children_in_poverty, percent_unemployed,
         percent_smokers,
         percent_obese,
         percent_excessive_drinking,
         percent_uninsured_x, 
         household_income,
         mentally_unhealthy_days,
         population_4,
         x65_and_over,
         african_american,
         hispanic,
         percent_not_proficient_in_english) %>%
  mutate(percent_uninsured = percent_uninsured_x) %>% select(-percent_uninsured_x)

# combine 2011 and 2012
rm(year_2011, 
   year_2011_v2,
   year_2012,
   year_2012_v2)

Combined2011and2012 <- full_join(combined_2011,
                            combined_2012,
                            by = c("county",
         "year",
         "rural",
         "female",
         "percent_children_in_poverty", "percent_unemployed",
         "percent_smokers",
         "percent_obese",
         "percent_excessive_drinking",
         "percent_uninsured", 
         "household_income",
         "mentally_unhealthy_days",
         "population_4",
         "x65_and_over",
         "african_american",
         "hispanic",
         "percent_not_proficient_in_english"))

# 2013
year_2013 <- read_excel("County_data/2013 County Health Ranking New York Data - v1_0.xlsx", 
    sheet = "Ranked Measure Data", skip = 1) %>%
  drop_na(County)

year_2013_v2 <- read_excel("County_data/2013 County Health Ranking New York Data - v1_0.xlsx", 
    sheet = "Additional Measure Data", skip = 1) %>%
  drop_na(County)

combined_2013 <- full_join(year_2013,
                           year_2013_v2,
                           by = "County")

combined_2013 <- combined_2013 %>%
  mutate(year = 2013) %>%
  clean_names() %>%
  select(county,
         year,
         rural,
         female,
         percent_children_in_poverty, percent_unemployed,
         percent_smokers,
         percent_obese,
         percent_excessive_drinking,
         percent_uninsured, 
         household_income,
         mentally_unhealthy_days,
         population_y,
         x65_and_over,
         african_american,
         hispanic,
         percent_not_proficient_in_english)

#View(combined_2013 %>% select(county, contains("population")))

# 2014
year_2014 <- read_excel("County_data/2014 County Health Rankings New York Data - v6.xlsx", 
    sheet = "Ranked Measure Data", skip = 1) %>%
  drop_na(County)

year_2014_v2 <- read_excel("County_data/2014 County Health Rankings New York Data - v6.xlsx", 
    sheet = "Additional Measure Data", skip = 1) %>%
  drop_na(County)

combined_2014 <- left_join(year_2014,
                           year_2014_v2,
                           by = "County")

combined_2014 <- combined_2014 %>%
  mutate(year = 2014) %>%
  clean_names() %>%
  select(county,
         year,
         rural,
         female,
         percent_children_in_poverty, percent_unemployed,
         percent_smokers,
         percent_obese,
         percent_excessive_drinking,
         percent_uninsured, 
         household_income,
         mentally_unhealthy_days,
         population_y,
         x65_and_over,
         african_american,
         hispanic,
         percent_not_proficient_in_english)

# 2015


# Final
rm(year_2011, 
   year_2011_v2,
   year_2012,
   year_2012_v2)

intersect(names(combined_2011), (combined_2012))

Combine_2011_2012 <- full_join(combined_2011,
                            combined_2012,
                            by = c("County", "year"),
                            keep = FALSE)

Combine_2011_2012 <- Combine_2011_2012 %>% pivot_longer(cols = c("year_2011", "year_2012"),
                                   names_to = "year",
                                   values_to = "value")

Combine_2011_2012 %>% select(contains("female"))
```

Did not finish above combination because of issues merging with year. 
