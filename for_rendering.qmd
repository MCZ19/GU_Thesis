---
title: "Loading_cleaned_data"
format: html
docx:
  toc: TRUE
editor: visual
warning: FALSE
embed-resources: true
---

## Setup

Load necessary libraries:

```{r}
library(tidyverse)
library(janitor)
library(hrbrthemes)
library(GGally)
library(tabulator)
library(readxl)
library(broom)
library(plm)
library(openxlsx)
library(sandwich)
library(lmtest)
library(stargazer)
library(gt)
library(patchwork)
library(estimatr)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
```

## Load Cleaned Data

```{r}

library(readxl)
Fully_combined_dataset <- read_excel("Fully_combined_dataset.xlsx")
View(Fully_combined_dataset)


#class("net_patient_revenue")
#class("net_charity_care_cost")

numeric_data <- Fully_combined_dataset %>%
  transform(net_patient_revenue = as.numeric(net_patient_revenue)) %>%
  transform(net_charity_care_cost = as.numeric(net_charity_care_cost)) %>%
  mutate(net_patient_revenue_hundred_thousand = net_patient_revenue/100000) %>%
  mutate(net_charity_care_cost_ten_thousand = net_charity_care_cost/10000) %>% mutate(year = as.factor(year))
  
```

## Naive linear regression.

```{r}

initial_reg <- lm(difference_in_discharges ~ hospital_ownership_type,data = numeric_data)

linear_summary <- summary(initial_reg)

linear_glance <- glance(initial_reg)

linear_tidy <- tidy(initial_reg)

linear_coef <- coeftest(initial_reg, vcov = vcovHC, type = "HC1")

table_initial_reg <- initial_reg %>% stargazer(type = "text", title = "Simple Linear Regression Results", report = "vcs*p", single.row = TRUE, ci = TRUE, ci.level = 0.95, mean.sd = TRUE, p.auto = TRUE, digits = 3, se_type = "HC1")

#linear_table <- linear_tidy %>% gt()

#linear_table_glance <- linear_glance %>% gt()

#linear_viz <- ggplot(data = numeric_data, mapping = aes(x = year, y = ppc_version)) + geom_point()

#linear_viz + plot_layout(linear_table + linear_table_glance) 
```

## Linear regression with controls.

```{r}

linear_control <- lm(difference_in_discharges ~ hospital_ownership_type + bed_size + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand + year + hospital_name.y,data = numeric_data)  

summary(linear_control) 

glance(linear_control)

View(tidy(linear_control))

coeftest(linear_control, vcov = vcovHC, type = "HC1")

table_control_linear_reg <- linear_control %>% stargazer(type = "text", title = " Linear Regression Results with Controls", report = "vcs*p", single.row = TRUE, ci = TRUE, ci.level = 0.95, mean.sd = TRUE, p.auto = TRUE, digits = 3, se_type = "HC1")

```

## Hospital Fixed Effects

```{r}

#hospital_fixed_effects <- lm(difference_in_discharges ~ hospital_ownership_type + hospital_name.y + bed_size + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand - 1,data = numeric_data)  

hospital_fixed_effects_plm <- plm(difference_in_discharges ~ hospital_ownership_type + hospital_name.y + bed_size + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand,
    data = numeric_data,
    index = c("hospital_name.y", "year"),
    model = "within")

summary(hospital_fixed_effects_plm) 

glance(hospital_fixed_effects_plm)
tidy(hospital_fixed_effects_plm)

coeftest(hospital_fixed_effects_plm, vcov = vcovHC, type = "HC1")

table_hospital_effects <- hospital_fixed_effects_plm %>% stargazer(type = "text", title = "Hospital Fixed Effects Regression", report = "vcs*p", single.row = TRUE, ci = TRUE, ci.level = 0.95, mean.sd = TRUE, p.auto = TRUE, digits = 3, se_type = "HC1")

#numeric_data %>% count(hospital_name.y) %>% arrange(by = n) 

#ask an economist. Could do entity wise demeaning. Do I have too many fixed effects for my dataset size?
```

## Time Fixed Effects

```{r}
#time_fixed_effects <- lm(difference_in_discharges ~ hospital_ownership_type + year + bed_size + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand - 1,data = numeric_data)  

time_fixed_effects_plm <- plm(difference_in_discharges ~ hospital_ownership_type + year + bed_size + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand,
                data = numeric_data)

summary(time_fixed_effects_plm) 

glance(time_fixed_effects_plm)

coeftest(time_fixed_effects_plm, vcov = vcovHC, type = "HC1")

table_time_effects <- time_fixed_effects_plm %>% stargazer(type = "text", title = "Year Fixed Effects Regression", report = "vcs*p", single.row = TRUE, ci = TRUE, ci.level = 0.95, mean.sd = TRUE, p.auto = TRUE, digits = 3, se_type = "HC1")
```

## Simple two-way fixed effects regression.

```{r}

fixed_effects <- plm(difference_in_discharges ~ hospital_ownership_type,
                     data = numeric_data,
                     index = c("year","hospital_name.y"),
                     model = "within",
                     effect = "twoways")

summary(fixed_effects)
glance(fixed_effects)
tidy(fixed_effects)
coeftest(fixed_effects, vcov = vcovHC, type = "HC1")

simple_twoway_fixed_effects <- fixed_effects %>% stargazer(type = "text", title = "Simple Two Way Fixed Effects Regression", report = "vcs*p", single.row = TRUE, ci = TRUE, ci.level = 0.95, mean.sd = TRUE, p.auto = TRUE, digits = 3, se_type = "HC1")
```

## Add control variables to fixed effects regression.

```{r}
Controls_added <- plm(difference_in_discharges ~ hospital_ownership_type + bed_size+ net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand,
                     data = numeric_data,
                     index = c("year","hospital_name.y"),
                     model = "within",
                     effect = "twoways")

summary(Controls_added)
glance(Controls_added)
tidy(Controls_added)

coeftest(Controls_added, vcov = vcovHC, type = "HC1")

fixed_effects_control <- Controls_added %>% stargazer(type = "text", title = "Two Way Fixed Effects with Controls", report = "vcs*p", single.row = TRUE, ci = TRUE, ci.level = 0.95, mean.sd = TRUE, p.auto = TRUE, digits = 3, se_type = "HC1")
```

## Stargazer Combined Table

```{r}

stargazer(initial_reg,
          linear_control,
          #fixed_effects, 
          type = "text",
          title = "Two Way Fixed Effects with Controls", 
          report = "vcs*p",
          single.row = TRUE,
          ci = TRUE, 
          ci.level = 0.95,
          mean.sd = TRUE, 
          p.auto = TRUE, 
          digits = 3, 
          se_type = "HC1")

stargazer(hospital_fixed_effects_plm,
          time_fixed_effects_plm,
          type = "text",
          title = "Two Way Fixed Effects with Controls", 
          report = "vcs*p",
          single.row = TRUE,
          ci = TRUE, 
          ci.level = 0.95,
          mean.sd = TRUE, 
          p.auto = TRUE, 
          digits = 3, 
          se_type = "HC1")

stargazer(fixed_effects,
          Controls_added,
          type = "text",
          title = "Two Way Fixed Effects with Controls", 
          report = "vcs*p",
          single.row = TRUE,
          ci = TRUE, 
          ci.level = 0.95,
          mean.sd = TRUE, 
          p.auto = TRUE, 
          digits = 3, 
          se_type = "HC1")
```

## Just looking at a scatterplot

```{r}
ggplot(data = Fully_combined_dataset,
       mapping = aes(x = hospital_ownership_type, y = difference_in_discharges, fill = year)) + geom_point(alpha = .3) + theme_minimal()

```

## Density plot

```{r}
ggplot(data = Fully_combined_dataset,
       mapping = aes(x = difference_in_discharges, group = hospital_ownership_type, fill = hospital_ownership_type)) + geom_density(alpha =0.6) + theme_minimal()
```

From Williams

\#' Create a regression table with clustered standard errors and drop the\
\#' coefficients from fixed effects.\
\#'\
\#' \@param model1\
\#' \@param model2\
\#' \@param model3\
\#' \@param model4\
\#'\
\#' \@return\
\#'\
create_model_table \<- function(model1, model2, model3, model4) {\
 \
  drop_fe \<- function(x, fe = "state\|cz2000") {\
   \
    x\[!grepl(fe, names(x))\]\
   \
  }\
 \
  se \<- starprep(model1,\
                 model2,\
                 model3,\
                 model4,\
                 se_type = "HC1") %\>%\
    map(drop_fe)\
 \
  model1\$coefficients \<- drop_fe(model1\$coefficients)\
  model2\$coefficients \<- drop_fe(model2\$coefficients)\
  model3\$coefficients \<- drop_fe(model3\$coefficients)\
  model4\$coefficients \<- drop_fe(model4\$coefficients)\
 \
  stargazer(model1,\
            model2,\
            model3,\
            model4,\
            se = se,\
            type = "html",\
            digits = 5)\
}

------------------------------------------------------------------------

Direct patient care? -\>

Along causal chain?

Groft page 39 or 43. Mediator check on Direct Patient Care.

Medicaid for patient income proxy. F test between them a charity care.

I do have zip code. Could try to match to local info online. hospital referral region (HRR) data? Maybe check Dartmouth Atlas.

------------------------------------------------------------------------

library(tidyverse)\
library(gt)\
library(patchwork)\
library(broom)\
\
model \<- lm(dist \~ speed, data = cars)\
\
\
table_coef \<- model \|\>\
tidy() \|\>\
gt()\
\
table_model \<- model \|\>\
  glance() \|\>\
  gt()\
\
viz \<- ggplot(data = cars, aes(speed, dist)) +\
  geom_point()

------------------------------------------------------------------------

<https://gt.rstudio.com/articles/case-study-gtcars.html>\
<https://gt.rstudio.com/articles/case-study-clinical-tables.html>

------------------------------------------------------------------------

for hw testthat testcheck() add r script
