---
title: "Loading_cleaned_data"
format: html
docx:
  toc: TRUE
editor: visual
warning: FALSE
embed-resources: true
---

## Setup

Load necessary libraries:

```{r}
library(tidyverse)
library(janitor)
library(hrbrthemes)
library(GGally)
library(tabulator)
library(readxl)
library(broom)
library(plm)
library(openxlsx)
library(sandwich)
library(lmtest)
library(stargazer)
library(gt)
library(patchwork)
library(estimatr)
library(tidymodels)
```

## Load Cleaned Data

```{r}

library(readxl)
Fully_combined_dataset <- read_excel("Fully_combined_dataset.xlsx")


#class("net_patient_revenue")
#class("net_charity_care_cost")

numeric_data <- Fully_combined_dataset %>%
  transform(net_patient_revenue = as.numeric(net_patient_revenue)) %>%
  transform(net_charity_care_cost = as.numeric(net_charity_care_cost)) %>%
  mutate(net_patient_revenue_hundred_thousand = net_patient_revenue/100000) %>%
  mutate(net_charity_care_cost_ten_thousand = net_charity_care_cost/10000) %>% mutate(year = as.factor(year))
  
```

Create dataset with different variable classes and rescaled for certain variables.

## Understanding data missingness

```{r}
#control variables 
sum(is.na(numeric_data$bed_size))
mean(is.na(numeric_data$bed_size))

sum(is.na(numeric_data$net_charity_care_cost_ten_thousand))
mean(is.na(numeric_data$net_charity_care_cost_ten_thousand))

sum(is.na(numeric_data$net_patient_revenue_hundred_thousand))
mean(is.na(numeric_data$net_patient_revenue_hundred_thousand))

#key dependent variable
sum(is.na(numeric_data$difference_in_discharges))
mean(is.na(numeric_data$difference_in_discharges))

#key independent variable.
sum(is.na(numeric_data$hospital_ownership_type))
mean(is.na(numeric_data$hospital_ownership_type))


#Look at a table with just the variables I am interested in.
View(numeric_data %>% group_by(hospital_name.y) %>% 
       select(year, 
              bed_size, 
              net_charity_care_cost_ten_thousand,
                       net_patient_revenue_hundred_thousand,
              difference_in_discharges,
              hospital_ownership_type))


```

Percent of missing observations.
-Difference in Discharges is .4259 or 895 obs.
-Hospital Ownership Type is .0048 or 10 obs. 
-Bed size is .0148 or 31 observations.
-Net Charity Care Cost is .0548 or 115 obs.
-Net Patient Revenue is .0157 or 33 obs. 

## Data Imputation

```{r}
numeric_tr <- numeric_data
numeric_te <- numeric_data
numeric_te_whole <- numeric_te

rec <- recipe(
  bed_size ~ difference_in_discharges + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand,
  data = numeric_te)

ratio_recipe <- rec %>%
  step_impute_knn(all_predictors(),
                  neighbors = 3)

ratio_rec2 <- prep(ratio_recipe, training = numeric_tr) 

imputed <- bake(ratio_rec2,
                numeric_te)

summary(imputed$difference_in_discharges)

full_imputed <- cbind(numeric_data,
                      imputed)

#use diff in discharge as outcome

numeric_tr2 <- numeric_data
numeric_te2 <- numeric_data
numeric_te_whole2 <- numeric_te2

rec2 <- recipe(
  net_patient_revenue_hundred_thousand ~ bed_size + difference_in_discharges + net_charity_care_cost_ten_thousand,
  data = numeric_te2)

ratio_recipe3 <- rec2 %>%
  step_impute_knn(all_predictors(),
                  neighbors = 3)

ratio_rec4 <- prep(ratio_recipe3, training = numeric_tr2) 

imputed2 <- bake(ratio_rec4,
                numeric_te2)

summary(imputed2$difference_in_discharges)
summary(imputed2)

full_imputed2 <- cbind(numeric_data,
                      imputed)

```



## Dealing with Observation Irregularities 

```{r}

imputed <- numeric_data %>% filter(!hospital_name.y == "BURDETT CARE CENTER", 
                                   !hospital_name.y == "ROCKEFFELLER UNIVERSITY HOSPITAL",
                                   !hospital_name.y == "BURDETT CARE CENTER INC.",
                                   !hospital_name.y == "BRUNSWICK HOSPITAL CENTER")


knn_recipe <- recipe(formula = difference_in_discharges ~ ., data = imputed) %>%
  step_normalize()

```
Rockerfeller and burdett are nas for all 3 controls. 

net charity care is missing for Memorial Hospital for Cancer and All and Roswell Park Cancer Institute. Missing Soldiers and Sailors Memorial Hospital early values net charity. 

Look at recipes package. Prep and bake recipe. step impute functions. 


Remove Rockeffeller University Hospital and Burdett Care Center because they have NAs for all three of my controls. 
Remove Brunswick Hospital Center because two controls have NAs. 
Consider removing "MEMORIAL HOSPITAL FOR CANCER AND ALL" as net charity care no observations. 


## Naive linear regression.

```{r}

initial_reg <- lm(difference_in_discharges ~ hospital_ownership_type, data = imputed)

linear_summary <- summary(initial_reg)

linear_glance <- glance(initial_reg)

linear_tidy <- tidy(initial_reg)

linear_coef <- coeftest(initial_reg, vcov = vcovHC, type = "HC1")

table_initial_reg <- initial_reg %>% stargazer(type = "text",
                                               title = "Simple Linear Regression Results",
                                               report = "vcs*",
                                               single.row = TRUE,
                                               digits = 3,
                                               omit.stat = c("f","ser","rsq"),
                                               se_type = "HC1")

#linear_table <- linear_tidy %>% gt()

#linear_table_glance <- linear_glance %>% gt()

#linear_viz <- ggplot(data = numeric_data, mapping = aes(x = year, y = ppc_version)) + geom_point()

#linear_viz + plot_layout(linear_table + linear_table_glance) 
```

## Linear regression with controls.

```{r}

linear_control <- lm(difference_in_discharges ~ hospital_ownership_type + bed_size + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand, data = numeric_data)  

summary(linear_control) 

glance(linear_control)

View(tidy(linear_control))

coeftest(linear_control, vcov = vcovHC, type = "HC1")

table_control_linear_reg <- linear_control %>% stargazer(type = "text",
                                               title = "Linear Regression with Controls Results",
                                               report = "vcs*",
                                               single.row = TRUE,
                                               digits = 3,
                                               omit.stat = c("f","ser","rsq"),
                                               se_type = "HC1")


```

## Hospital Fixed Effects

```{r}

#hospital_fixed_effects <- lm(difference_in_discharges ~ hospital_ownership_type + hospital_name.y + bed_size + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand - 1,data = numeric_data)  

hospital_fixed_effects_plm <- plm(difference_in_discharges ~ hospital_ownership_type + hospital_name.y + bed_size + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand,
    data = numeric_data,
    index = c("hospital_name.y", "year"),
    model = "within",
    effect = "individual")

summary(hospital_fixed_effects_plm) 

glance(hospital_fixed_effects_plm)
tidy(hospital_fixed_effects_plm)

coeftest(hospital_fixed_effects_plm, vcov = vcovHC, type = "HC1")

table_hospital_effects <- hospital_fixed_effects_plm %>% stargazer(type = "text",
                                               title = "Hospital Fixed Effect Regression Results",
                                               report = "vcs*",
                                               single.row = TRUE,
                                               digits = 3,
                                               omit.stat = c("f","ser","rsq"),
                                               se_type = "HC1")


#numeric_data %>% count(hospital_name.y) %>% arrange(by = n) 

#ask an economist. Could do entity wise demeaning. Do I have too many fixed effects for my dataset size?
```

## Time Fixed Effects

```{r}
#time_fixed_effects <- lm(difference_in_discharges ~ hospital_ownership_type + year + bed_size + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand - 1,data = numeric_data)  

time_fixed_effects_plm <- plm(difference_in_discharges ~ hospital_ownership_type + year + hospital_name.y + bed_size + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand,
                data = numeric_data,
    index = c("hospital_name.y", "year"),
    model = "within",
    effect = "twoways")

summary(time_fixed_effects_plm) 

glance(time_fixed_effects_plm)

coeftest(time_fixed_effects_plm, vcov = vcovHC, type = "HC1")

table_time_effects <- time_fixed_effects_plm %>% stargazer(type = "text",
                                               title = "Simple Linear Regression Results",
                                               report = "vcs*",
                                               single.row = TRUE,
                                               digits = 3,
                                               omit.stat = c("f","ser","rsq"),
                                               se_type = "HC1")

```

## Simple two-way fixed effects regression.

```{r}

fixed_effects <- plm(difference_in_discharges ~ hospital_ownership_type,
                     data = numeric_data,
                     index = c("year","hospital_name.y"),
                     model = "within",
                     effect = "twoways")

summary(fixed_effects)
glance(fixed_effects)
tidy(fixed_effects)
coeftest(fixed_effects, vcov = vcovHC, type = "HC1")

simple_twoway_fixed_effects <- fixed_effects %>% stargazer(type = "text",
                                               title = "Simple Linear Regression Results",
                                               report = "vcs*",
                                               single.row = TRUE,
                                               digits = 3,
                                               omit.stat = c("f","ser","rsq"),
                                               se_type = "HC1")

```

## Add control variables to fixed effects regression.

```{r}
Controls_added <- plm(difference_in_discharges ~ hospital_ownership_type + bed_size+ net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand,
                     data = numeric_data,
                     index = c("year","hospital_name.y"),
                     model = "within",
                     effect = "twoways")

summary(Controls_added)
glance(Controls_added)
tidy(Controls_added)

coeftest(Controls_added, vcov = vcovHC, type = "HC1")

fixed_effects_control <- Controls_added %>%  stargazer(type = "text",
                                               title = "Simple Linear Regression Results",
                                               report = "vcs*",
                                               single.row = TRUE,
                                               digits = 3,
                                               omit.stat = c("f","ser","rsq"),
                                               se_type = "HC1")
```

## Stargazer Prep
```{r}
m1 <- initial_reg
m2 <- linear_control
m3 <- hospital_fixed_effects_plm
m4 <- time_fixed_effects_plm
```


## Stargazer Combined Table

```{r}

Complete_init_table <- stargazer(m1,
          m2, 
          m3, 
          m4,
          type = "text",
          title = "All Four Regression Models", 
                                               report = "vcs*",
                                               single.row = TRUE,
                                               digits = 3,
                                               covariate.labels = c("Governmental Hospitals", "Non-Profit Hospitals", "Number of Beds", "Net Patient Revenue (Hundreds of Thousands of Dollars)", "Net Charity Care Costs (Tens of Thousands of Dollars"),
                                               column.labels = c("Simple Linear", "Linear with Controls", "Hospital Fixed Effects", "Two Way Fixed Effects"),
                                               omit.stat = c("f","ser","rsq"),
                                               se_type = "HC1",
                                               dep.var.labels = "Observed vs. Expected PPCs")

#summary(Compare_lm_table)

Compare_single_effects_table <- stargazer(hospital_fixed_effects_plm,
          time_fixed_effects_plm,
          type = "html",
          title = "Hospital Fixed Effects vs. Year Fixed Effects", 
          report = "vcs*p",
          single.row = TRUE,
          ci = TRUE, 
          ci.level = 0.95,
          mean.sd = TRUE, 
          p.auto = TRUE, 
          digits = 3, 
          se_type = "HC1",
          out = "Compare_single_effects_table.htm")

#summary(Compare_single_effects_table)

Compare_twoway_effects_table <- stargazer(fixed_effects,
          Controls_added,
          type = "html",
          title = "Simple Two Way Fixed Effects vs. Two Way Fixed Effects with Controls", 
          report = "vcs*p",
          single.row = TRUE,
          ci = TRUE, 
          ci.level = 0.95,
          mean.sd = TRUE, 
          p.auto = TRUE, 
          digits = 3, 
          se_type = "HC1",
          out = "Compare_twoway_effects_table.htm")

#summary(Compare_twoway_effects_table)


```

## Just looking at a scatterplot

```{r}
ggplot(data = Fully_combined_dataset,
       mapping = aes(x = hospital_ownership_type, y = difference_in_discharges, fill = year)) + geom_point(alpha = .3) + theme_minimal()

```

## Density plot

```{r}
ggplot(data = Fully_combined_dataset,
       mapping = aes(x = difference_in_discharges, group = hospital_ownership_type, fill = hospital_ownership_type)) + geom_density(alpha =0.6) + theme_minimal()
```

From Williams

\#' Create a regression table with clustered standard errors and drop the\
\#' coefficients from fixed effects.\
\#'\
\#' \@param model1\
\#' \@param model2\
\#' \@param model3\
\#' \@param model4\
\#'\
\#' \@return\
\#'\
create_model_table \<- function(model1, model2, model3, model4) {\
 \
  drop_fe \<- function(x, fe = "state\|cz2000") {\
   \
    x\[!grepl(fe, names(x))\]\
   \
  }\
 \
  se \<- starprep(model1,\
                 model2,\
                 model3,\
                 model4,\
                 se_type = "HC1") %\>%\
    map(drop_fe)\
 \
  model1\$coefficients \<- drop_fe(model1\$coefficients)\
  model2\$coefficients \<- drop_fe(model2\$coefficients)\
  model3\$coefficients \<- drop_fe(model3\$coefficients)\
  model4\$coefficients \<- drop_fe(model4\$coefficients)\
 \
  stargazer(model1,\
            model2,\
            model3,\
            model4,\
            se = se,\
            type = "html",\
            digits = 5)\
}

------------------------------------------------------------------------

Direct patient care? -\>

Along causal chain?

Groft page 39 or 43. Mediator check on Direct Patient Care.

Medicaid for patient income proxy. F test between them a charity care.

I do have zip code. Could try to match to local info online. hospital referral region (HRR) data? Maybe check Dartmouth Atlas.

------------------------------------------------------------------------

library(tidyverse)\
library(gt)\
library(patchwork)\
library(broom)\
\
model \<- lm(dist \~ speed, data = cars)\
\
\
table_coef \<- model \|\>\
tidy() \|\>\
gt()\
\
table_model \<- model \|\>\
  glance() \|\>\
  gt()\
\
viz \<- ggplot(data = cars, aes(speed, dist)) +\
  geom_point()

------------------------------------------------------------------------

<https://gt.rstudio.com/articles/case-study-gtcars.html>\
<https://gt.rstudio.com/articles/case-study-clinical-tables.html>

------------------------------------------------------------------------

for hw testthat testcheck() add r script

```{r}
lark <- lm(difference_in_discharges ~ hospital_ownership_type + bed_size + net_patient_revenue_hundred_thousand + net_charity_care_cost_ten_thousand + hos_majteach + hos_highuc + hos_res,
   data = numeric_data) 

glance(lark)

tidy(lark)

summary(lark)
```

Use case when to make urban vs rural divide.
